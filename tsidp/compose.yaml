# https://runtimeterror.dev/tsidp-effortless-sso-tailnet/
# https://github.com/tailscale/tsidp
# Built from source because the published Docker image's run.sh entrypoint
# does not pass TS_ADVERTISE_TAGS to tsnet, breaking OAuth auth keys.
# Building from source uses the Dockerfile's ENTRYPOINT ["/tsidp-server"],
# which reads TS_ADVERTISE_TAGS directly from the environment.
services:
  tsidp:
    build:
      context: ./tsidp
      dockerfile: Dockerfile
    container_name: tsidp
    user: 1000:1000
    environment:
      - TS_HOSTNAME=tsidp
      - TAILSCALE_USE_WIP_CODE=1
      - TS_ADVERTISE_TAGS=tag:container
      - TS_STATE_DIR=/data
      - TS_AUTHKEY=${TS_AUTHKEY}
    volumes:
      - /mnt/2000/container-mounts/tsidp/tsidp:/data
    labels:
      # For homepage
      - homepage.group=Tools
      - homepage.name=Tailscale OIDC IdP (New)
      - homepage.weight=40
      - homepage.icon=/dashboard-icons/svg/tailscale.svg
      - homepage.href=https://tsidp.${TS_DOMAIN}
    healthcheck:
      test: ["CMD-SHELL", "pgrep tsidp-server"]
      start_period: 120s
      start_interval: 5s
      interval: 5m
      timeout: 5s
      retries: 3
